

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?
  role          UserRole  @default(AGENT)
  phone         String?   @unique
  callerDeskPhone String? // Assigned CallerDesk IVR/Deskphone number
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Authentication Relations
  accounts Account[]
  sessions Session[]

  // CRM Relations
  ownedLeads       Lead[]           @relation("LeadOwner")
  createdLeads     Lead[]           @relation("LeadCreator")
  activities       Activity[]
  tasks            Task[]           @relation("TaskAssignee")
  createdTasks     Task[]           @relation("TaskCreator")
  notes            Note[]
  calls            Call[]
  deals            Deal[]           @relation("DealAssignee")
  campaigns        Campaign[]       @relation("CampaignCreator")
  campaignMembers  CampaignMember[]
  
  // Workspace Relations
  workspaces       WorkspaceMember[]
  webhookAssignmentRules WebhookAssignmentRule[]

  // Team Relations
  teamId           String?
  team             Team?            @relation("TeamMembers", fields: [teamId], references: [id])
  managedTeams     Team[]           @relation("TeamManager")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// OTP for phone-based authentication
model Otp {
  id        String   @id @default(cuid())
  phone     String
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([otp])
  @@map("otps")
}

enum UserRole {
  SUPER_ADMIN // Platform super admin - can manage workspaces
  ADMIN      // Platform admin - full access (Legacy, maybe migrate to Workspace Admin)
  MANAGER    // Team manager - manage team and leads
  AGENT      // Sales agent - handle leads and calls
  VIEWER     // Read-only access
}

// ============================================
// WORKSPACE MANAGEMENT (Multi-Tenancy)
// ============================================

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  
  // Settings
  settings    String?  // JSON settings
  
  // Webhook Security
  webhookToken String? @unique // Unique token for webhook authentication
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     WorkspaceMember[]
  leads       Lead[]
  campaigns   Campaign[]
  tasks       Task[]
  teams       Team[]
  courses     Course[]
  activities  Activity[]
  calls       Call[]
  notes       Note[]
  payments    Payment[]
  batches     Batch[]
  dailyStats  DailyStats[]
  configSettings Setting[]
  integrations Integration[]
  whatsappTriggers WhatsAppTrigger[]
  leadFields  LeadField[]
  deals       Deal[]
  webhookAssignmentRules WebhookAssignmentRule[]

  @@map("workspaces")
}

model LeadField {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name        String   // Display Name (e.g. "Course Purchased")
  key         String   // Internal key (e.g. "course_purchased")
  type        String   // TEXT, NUMBER, SELECT, DATE, BOOLEAN, EMAIL, PHONE
  options     String?  // JSON array for SELECT options
  
  order       Int      @default(0)
  isVisible   Boolean  @default(true)
  isRequired  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@map("lead_fields")
}


model WhatsAppTrigger {
  id                 String   @id @default(cuid())
  workspaceId        String
  workspace          Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  status             String
  isEnabled          Boolean  @default(false)
  campaignName       String?
  source             String?  @default("CRM")
  templateParamsJson String?  @default("[]")
  paramsFallbackJson String?  @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([workspaceId, status])
  @@map("whatsapp_triggers")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        WorkspaceRole @default(MEMBER)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

enum WorkspaceRole {
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

// ============================================
// TEAM MANAGEMENT
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  managerId   String
  manager     User     @relation("TeamManager", fields: [managerId], references: [id])
  members     User[]   @relation("TeamMembers")
  
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@map("teams")
}

// ============================================
// LEAD MANAGEMENT (Core CRM Feature)
// ============================================

model Lead {
  id          String      @id @default(cuid())
  
  // Basic Information
  firstName   String
  lastName    String?
  email       String?
  phone       String
  altPhone    String?
  
  // Lead Details
  source      LeadSource      @default(WEBSITE)
  category    LeadCategory    @default(FRESH)
  status      LeadStatus      @default(NEW_LEAD)
  priority    Priority        @default(MEDIUM)
  
  // Course Interest (for EasyLearning)
  courseInterested String?
  courseLevel      String?    // Beginner, Intermediate, Advanced
  preferredBatch   String?
  budget           Float?
  
  // Additional Lead Details (from PHP system)
  revenue          Float?     @default(0)
  feedbackNeeded   Boolean    @default(false)
  leadType         String?    // e.g., "Hot", "Warm", "Cold"
  className        String?    // Class name or grade
  medium           String?    // Medium of instruction
  batch            String?    // Batch identifier
  campaign         String?    // Campaign name/source
  doneAt           DateTime?  // When lead was marked as done
  
  // Location
  city        String?
  state       String?
  country     String?     @default("India")
  pincode     String?
  address     String?
  
  // Assignment
  ownerId     String?
  owner       User?       @relation("LeadOwner", fields: [ownerId], references: [id])
  createdById String
  createdBy   User        @relation("LeadCreator", fields: [createdById], references: [id])
  assignedAt  DateTime?   // When lead was assigned
  assignedBy  String?     // Who assigned the lead (for tracking)
  
  // Follow-up
  nextFollowUp  DateTime?
  lastContactAt DateTime?
  
  // Conversion
  isConverted   Boolean   @default(false)
  convertedAt   DateTime?
  
  // Custom Fields (JSON for flexibility)
  customFields  String?   // JSON string
  
  // Tags
  tags          String?   // Comma-separated tags
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Workspace
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations
  activities  Activity[]
  tasks       Task[]
  notes       Note[]
  calls       Call[]
  payments    Payment[]
  deals       Deal[]
  campaignLeads CampaignLead[]

  @@index([status])
  @@index([ownerId])
  @@index([phone])
  @@index([email])
  @@index([workspaceId])
  @@map("leads")
}

enum LeadSource {
  WEBSITE
  FACEBOOK
  INSTAGRAM
  GOOGLE_ADS
  LINKEDIN
  REFERRAL
  WALK_IN
  PHONE_INQUIRY
  WHATSAPP
  EMAIL_CAMPAIGN
  EXHIBITION
  PARTNER
  WEBHOOK
  OTHER
}

enum LeadCategory {
  FRESH
  ACTIVE
  CLOSED
}

enum LeadStatus {
  // Fresh Category
  NEW_LEAD
  
  // Active Category
  INTERESTED
  JUST_CURIOUS
  FOLLOW_UP
  CONTACTED
  QUALIFIED
  NEGOTIATION
  
  // Closed Category
  NO_RESPONSE
  NOT_INTERESTED
  CONVERTED
  LOST
  DO_NOT_CONTACT
  WON
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// ACTIVITY TRACKING
// ============================================

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  subject     String?      // Made optional for simpler activity logs
  description String?      // Renamed from message, stores activity details
  message     String?      // Activity message/note
  
  // Relations
  leadId      String
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?        @relation(fields: [userId], references: [id])
  
  // Timestamps
  performedAt DateTime?    // Made optional
  createdAt   DateTime     @default(now())

  // Workspace
  workspaceId String?
  workspace   Workspace?   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([workspaceId])
  @@map("activities")
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  SMS
  WHATSAPP
  NOTE
  STATUS_CHANGE
  TASK_COMPLETED
  LEAD_ASSIGNED
  FOLLOW_UP_SCHEDULED
  EDIT
  SYSTEM
}

// ============================================
// TASK MANAGEMENT
// ============================================

model Task {
  id          String     @id @default(cuid())
  title       String?    // Made optional
  description String?    // Renamed from note
  note        String?    // Task note/details
  dueDate     DateTime?  // Renamed from dueAt
  dueAt       DateTime?  // Alternative field name from PHP
  priority    Priority   @default(MEDIUM)
  status      TaskStatus @default(PENDING)
  
  // Assignment
  assigneeId  String
  assignee    User       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdById String?
  createdBy   User?      @relation("TaskCreator", fields: [createdById], references: [id])
  
  // Lead Relation (optional)
  leadId      String?
  lead        Lead?      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Completion
  completedAt DateTime?
  
  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Workspace
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([workspaceId])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  UPCOMING
}

// ============================================
// NOTES
// ============================================

model Note {
  id        String   @id @default(cuid())
  content   String
  
  // Relations
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Workspace
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([workspaceId])
  @@map("notes")
}

// ============================================
// CALL MANAGEMENT (TeleCRM Feature)
// ============================================

model Call {
  id            String      @id @default(cuid())
  
  // Call Details
  type          CallType    @default(OUTBOUND)
  status        CallStatus  @default(COMPLETED)
  duration      Int?        // In seconds
  
  // Phone Numbers
  fromNumber    String?
  toNumber      String
  
  // Recording
  recordingUrl  String?
  
  // Notes
  notes         String?
  outcome       CallOutcome?
  
  // Relations
  leadId        String
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  
  // Follow-up
  nextFollowUp  DateTime?
  
  // Timestamps
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  createdAt     DateTime    @default(now())

  // Workspace
  workspaceId   String?
  workspace     Workspace?  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([workspaceId])
  @@map("calls")
}

enum CallType {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  VOICEMAIL
}

enum CallOutcome {
  INTERESTED
  NOT_INTERESTED
  CALLBACK_REQUESTED
  WRONG_NUMBER
  NOT_REACHABLE
  CALL_BACK_LATER
  CONVERTED
  INFORMATION_SHARED
}

// ============================================
// CAMPAIGN MANAGEMENT
// ============================================

model Campaign {
  id            String         @id @default(cuid())
  name          String
  description   String?
  type          CampaignType   @default(EMAIL)
  status        CampaignStatus @default(DRAFT)
  
  // Target
  targetAudience String?       // JSON criteria
  
  // Schedule
  startDate     DateTime?
  endDate       DateTime?
  
  // Budget
  budget        Float?
  actualSpend   Float?         @default(0)
  
  // Metrics
  totalLeads    Int            @default(0)
  convertedLeads Int           @default(0)
  
  // Creator
  createdById   String
  createdBy     User           @relation("CampaignCreator", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Workspace
  workspaceId   String?
  workspace     Workspace?     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations
  members       CampaignMember[]
  leads         CampaignLead[]
  webhookRules  WebhookAssignmentRule[] // Webhook rules that assign to this campaign

  @@index([workspaceId])
  @@map("campaigns")
}

enum CampaignType {
  EMAIL
  SMS
  WHATSAPP
  CALLING
  SOCIAL_MEDIA
  MIXED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model CampaignMember {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  role        String   @default("member")
  
  createdAt   DateTime @default(now())

  @@unique([campaignId, userId])
  @@map("campaign_members")
}

model CampaignLead {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Status within campaign
  status      String   @default("pending") // pending, contacted, converted
  
  createdAt   DateTime @default(now())

  @@unique([campaignId, leadId])
  @@map("campaign_leads")
}

// ============================================
// COURSE MANAGEMENT (EasyLearning Specific)
// ============================================

model Course {
  id            String   @id @default(cuid())
  name          String
  code          String   @unique
  description   String?
  category      String?
  
  // Pricing
  price         Float
  discountPrice Float?
  currency      String   @default("INR")
  
  // Duration
  durationDays  Int?
  durationHours Int?
  
  // Mode
  mode          CourseMode @default(ONLINE)
  
  // Status
  isActive      Boolean  @default(true)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Workspace
  workspaceId   String?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations
  batches       Batch[]

  @@index([workspaceId])

  @@map("courses")
}

enum CourseMode {
  ONLINE
  OFFLINE
  HYBRID
}

model Batch {
  id            String      @id @default(cuid())
  name          String
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Schedule
  startDate     DateTime
  endDate       DateTime?
  timing        String?     // e.g., "9:00 AM - 12:00 PM"
  days          String?     // e.g., "Mon, Wed, Fri"
  
  // Capacity
  maxStudents   Int         @default(30)
  enrolledCount Int         @default(0)
  
  // Status
  status        BatchStatus @default(UPCOMING)
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Workspace
  workspaceId   String?
  workspace     Workspace?  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("batches")
}

enum BatchStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime
  
  // Workspace
  workspaceId     String?
  workspace       Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Lead Stats
  newLeads        Int      @default(0)
  contactedLeads  Int      @default(0)
  qualifiedLeads  Int      @default(0)
  convertedLeads  Int      @default(0)
  lostLeads       Int      @default(0)
  
  // Call Stats
  totalCalls      Int      @default(0)
  connectedCalls  Int      @default(0)
  avgCallDuration Int      @default(0)
  
  // Deal Stats
  newDeals        Int      @default(0)
  wonDeals        Int      @default(0)
  lostDeals       Int      @default(0)
  dealValue       Float    @default(0)
  
  // Task Stats
  tasksCreated    Int      @default(0)
  tasksCompleted  Int      @default(0)
  
  createdAt       DateTime @default(now())

  @@unique([date, workspaceId])
  @@index([workspaceId])
  @@map("daily_stats")
}

// ============================================
// PAYMENT TRACKING
// ============================================

model Payment {
  id            String        @id @default(cuid())
  
  // Payment Details
  amount        Float
  currency      String        @default("INR")
  paymentMode   PaymentMode   @default(ONLINE)
  status        PaymentStatus @default(PENDING)
  
  // Transaction Details
  transactionId String?
  referenceNo   String?
  paymentDate   DateTime?
  
  // Payment Gateway
  gateway       String?       // Razorpay, Stripe, etc.
  gatewayResponse String?     // JSON string
  
  // Lead Relation (Changed from Deal)
  leadId        String?
  lead          Lead?         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Notes
  notes         String?
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Workspace
  workspaceId   String?
  workspace     Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([status])
  @@index([workspaceId])
  @@map("payments")
}

enum PaymentMode {
  CASH
  ONLINE
  CARD
  UPI
  CHEQUE
  BANK_TRANSFER
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_PAID
}

// ============================================
// DEAL MANAGEMENT
// ============================================

model Deal {
  id          String     @id @default(cuid())
  title       String
  value       Float      @default(0)
  currency    String     @default("INR")
  stage       DealStage  @default(PROSPECT)
  probability Int        @default(0) // 0-100%
  expectedCloseDate DateTime?

  // Relations
  leadId      String?
  lead        Lead?      @relation(fields: [leadId], references: [id])
  assigneeId  String?
  assignee    User?      @relation("DealAssignee", fields: [assigneeId], references: [id])
  
  // Workspace
  workspaceId String
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([workspaceId])
  @@index([stage])
  @@map("deals")
}

enum DealStage {
  PROSPECT
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String   @default("general")
  
  // Workspace
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, workspaceId])
  @@index([workspaceId])
  @@map("settings")
}

// ============================================
// INTEGRATIONS
// ============================================

model Integration {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  provider    String   // e.g. "CALLERDESK"
  config      String   // JSON string
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@map("integrations")
}

// Webhook Assignment Rules
model WebhookAssignmentRule {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Rule conditions (all optional, acts as filters)
  source      String?  // Source that triggers this rule (WEBSITE, FACEBOOK, custom, etc.)
  status      String?  // NEW, CONTACTED, etc.
  priority    Int      @default(0) // Rule execution priority (lower = higher priority)
  
  // Campaign Assignment (NEW: assign leads to campaigns based on source)
  campaignId  String?  // Target campaign to add leads to
  campaign    Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  // User Assignment
  assignmentType String @default("SPECIFIC") // SPECIFIC, ROUND_ROBIN, PERCENTAGE
  percentage     Int?   // For percentage-based assignment (0-100)
  
  assigneeId  String
  assignee    User     @relation(fields: [assigneeId], references: [id], onDelete: Cascade)
  
  lastAssignedAt DateTime?
  assignmentCount Int @default(0)
  
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([assigneeId])
  @@index([campaignId])
  @@map("webhook_assignment_rules")
}

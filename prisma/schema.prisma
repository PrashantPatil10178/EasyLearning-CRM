// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?
  role          UserRole  @default(AGENT)
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Authentication Relations
  accounts Account[]
  sessions Session[]

  // CRM Relations
  ownedLeads       Lead[]           @relation("LeadOwner")
  createdLeads     Lead[]           @relation("LeadCreator")
  activities       Activity[]
  tasks            Task[]           @relation("TaskAssignee")
  createdTasks     Task[]           @relation("TaskCreator")
  notes            Note[]
  calls            Call[]
  campaigns        Campaign[]       @relation("CampaignCreator")
  campaignMembers  CampaignMember[]
  deals            Deal[]           @relation("DealOwner")
  createdDeals     Deal[]           @relation("DealCreator")
  
  // Team Relations
  teamId           String?
  team             Team?            @relation("TeamMembers", fields: [teamId], references: [id])
  managedTeams     Team[]           @relation("TeamManager")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserRole {
  ADMIN      // Platform admin - full access
  MANAGER    // Team manager - manage team and leads
  AGENT      // Sales agent - handle leads and calls
  VIEWER     // Read-only access
}

// ============================================
// TEAM MANAGEMENT
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  managerId   String
  manager     User     @relation("TeamManager", fields: [managerId], references: [id])
  members     User[]   @relation("TeamMembers")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("teams")
}

// ============================================
// LEAD MANAGEMENT (Core CRM Feature)
// ============================================

model Lead {
  id          String      @id @default(cuid())
  
  // Basic Information
  firstName   String
  lastName    String?
  email       String?
  phone       String
  altPhone    String?
  
  // Lead Details
  source      LeadSource  @default(WEBSITE)
  status      LeadStatus  @default(NEW)
  priority    Priority    @default(MEDIUM)
  
  // Course Interest (for EasyLearning)
  courseInterested String?
  courseLevel      String?    // Beginner, Intermediate, Advanced
  preferredBatch   String?
  budget           Float?
  
  // Location
  city        String?
  state       String?
  country     String?     @default("India")
  pincode     String?
  address     String?
  
  // Assignment
  ownerId     String?
  owner       User?       @relation("LeadOwner", fields: [ownerId], references: [id])
  createdById String
  createdBy   User        @relation("LeadCreator", fields: [createdById], references: [id])
  
  // Follow-up
  nextFollowUp  DateTime?
  lastContactAt DateTime?
  
  // Conversion
  isConverted   Boolean   @default(false)
  convertedAt   DateTime?
  
  // Custom Fields (JSON for flexibility)
  customFields  String?   // JSON string
  
  // Tags
  tags          String?   // Comma-separated tags
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  activities  Activity[]
  tasks       Task[]
  notes       Note[]
  calls       Call[]
  deal        Deal?
  campaignLeads CampaignLead[]

  @@index([status])
  @@index([ownerId])
  @@index([phone])
  @@index([email])
  @@map("leads")
}

enum LeadSource {
  WEBSITE
  FACEBOOK
  INSTAGRAM
  GOOGLE_ADS
  LINKEDIN
  REFERRAL
  WALK_IN
  PHONE_INQUIRY
  WHATSAPP
  EMAIL_CAMPAIGN
  EXHIBITION
  PARTNER
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  NOT_INTERESTED
  FOLLOW_UP
  QUALIFIED
  NEGOTIATION
  CONVERTED
  LOST
  DO_NOT_CONTACT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// DEAL / OPPORTUNITY MANAGEMENT
// ============================================

model Deal {
  id            String      @id @default(cuid())
  name          String
  amount        Float
  currency      String      @default("INR")
  
  // Deal Stage
  stage         DealStage   @default(QUALIFICATION)
  probability   Int         @default(10)  // Win probability %
  
  // Course Details (for EasyLearning)
  courseName    String?
  courseDuration String?
  batchStartDate DateTime?
  
  // Dates
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  
  // Assignment
  ownerId       String
  owner         User        @relation("DealOwner", fields: [ownerId], references: [id])
  createdById   String
  createdBy     User        @relation("DealCreator", fields: [createdById], references: [id])
  
  // Lead Relation
  leadId        String      @unique
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Notes
  notes         String?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([stage])
  @@index([ownerId])
  @@map("deals")
}

enum DealStage {
  QUALIFICATION
  NEEDS_ANALYSIS
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

// ============================================
// ACTIVITY TRACKING
// ============================================

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  subject     String
  description String?
  
  // Relations
  leadId      String
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  
  // Timestamps
  performedAt DateTime     @default(now())
  createdAt   DateTime     @default(now())

  @@index([leadId])
  @@index([userId])
  @@map("activities")
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  SMS
  WHATSAPP
  NOTE
  STATUS_CHANGE
  TASK_COMPLETED
  DEAL_CREATED
  LEAD_ASSIGNED
  FOLLOW_UP_SCHEDULED
}

// ============================================
// TASK MANAGEMENT
// ============================================

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  priority    Priority   @default(MEDIUM)
  status      TaskStatus @default(PENDING)
  
  // Assignment
  assigneeId  String
  assignee    User       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdById String
  createdBy   User       @relation("TaskCreator", fields: [createdById], references: [id])
  
  // Lead Relation (optional)
  leadId      String?
  lead        Lead?      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Completion
  completedAt DateTime?
  
  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// NOTES
// ============================================

model Note {
  id        String   @id @default(cuid())
  content   String
  
  // Relations
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@map("notes")
}

// ============================================
// CALL MANAGEMENT (TeleCRM Feature)
// ============================================

model Call {
  id            String      @id @default(cuid())
  
  // Call Details
  type          CallType    @default(OUTBOUND)
  status        CallStatus  @default(COMPLETED)
  duration      Int?        // In seconds
  
  // Phone Numbers
  fromNumber    String?
  toNumber      String
  
  // Recording
  recordingUrl  String?
  
  // Notes
  notes         String?
  outcome       CallOutcome?
  
  // Relations
  leadId        String
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  
  // Follow-up
  nextFollowUp  DateTime?
  
  // Timestamps
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  createdAt     DateTime    @default(now())

  @@index([leadId])
  @@index([userId])
  @@map("calls")
}

enum CallType {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  VOICEMAIL
}

enum CallOutcome {
  INTERESTED
  NOT_INTERESTED
  CALLBACK_REQUESTED
  WRONG_NUMBER
  NOT_REACHABLE
  CALL_BACK_LATER
  CONVERTED
  INFORMATION_SHARED
}

// ============================================
// CAMPAIGN MANAGEMENT
// ============================================

model Campaign {
  id            String         @id @default(cuid())
  name          String
  description   String?
  type          CampaignType   @default(EMAIL)
  status        CampaignStatus @default(DRAFT)
  
  // Target
  targetAudience String?       // JSON criteria
  
  // Schedule
  startDate     DateTime?
  endDate       DateTime?
  
  // Budget
  budget        Float?
  actualSpend   Float?         @default(0)
  
  // Metrics
  totalLeads    Int            @default(0)
  convertedLeads Int           @default(0)
  
  // Creator
  createdById   String
  createdBy     User           @relation("CampaignCreator", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  members       CampaignMember[]
  leads         CampaignLead[]

  @@map("campaigns")
}

enum CampaignType {
  EMAIL
  SMS
  WHATSAPP
  CALLING
  SOCIAL_MEDIA
  MIXED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model CampaignMember {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  role        String   @default("member")
  
  createdAt   DateTime @default(now())

  @@unique([campaignId, userId])
  @@map("campaign_members")
}

model CampaignLead {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Status within campaign
  status      String   @default("pending") // pending, contacted, converted
  
  createdAt   DateTime @default(now())

  @@unique([campaignId, leadId])
  @@map("campaign_leads")
}

// ============================================
// COURSE MANAGEMENT (EasyLearning Specific)
// ============================================

model Course {
  id            String   @id @default(cuid())
  name          String
  code          String   @unique
  description   String?
  category      String?
  
  // Pricing
  price         Float
  discountPrice Float?
  currency      String   @default("INR")
  
  // Duration
  durationDays  Int?
  durationHours Int?
  
  // Mode
  mode          CourseMode @default(ONLINE)
  
  // Status
  isActive      Boolean  @default(true)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  batches       Batch[]

  @@map("courses")
}

enum CourseMode {
  ONLINE
  OFFLINE
  HYBRID
}

model Batch {
  id            String      @id @default(cuid())
  name          String
  courseId      String
  course        Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Schedule
  startDate     DateTime
  endDate       DateTime?
  timing        String?     // e.g., "9:00 AM - 12:00 PM"
  days          String?     // e.g., "Mon, Wed, Fri"
  
  // Capacity
  maxStudents   Int         @default(30)
  enrolledCount Int         @default(0)
  
  // Status
  status        BatchStatus @default(UPCOMING)
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("batches")
}

enum BatchStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  
  // Lead Stats
  newLeads        Int      @default(0)
  contactedLeads  Int      @default(0)
  qualifiedLeads  Int      @default(0)
  convertedLeads  Int      @default(0)
  lostLeads       Int      @default(0)
  
  // Call Stats
  totalCalls      Int      @default(0)
  connectedCalls  Int      @default(0)
  avgCallDuration Int      @default(0)
  
  // Deal Stats
  newDeals        Int      @default(0)
  wonDeals        Int      @default(0)
  lostDeals       Int      @default(0)
  dealValue       Float    @default(0)
  
  // Task Stats
  tasksCreated    Int      @default(0)
  tasksCompleted  Int      @default(0)
  
  createdAt       DateTime @default(now())

  @@map("daily_stats")
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String   @default("general")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}
